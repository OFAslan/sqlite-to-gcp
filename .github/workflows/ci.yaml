name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT_ID: otto-pipeline-practice
  REGION: EU

jobs:
  # Job 1: Lint and validate DAGs
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install flake8 pytest apache-airflow apache-airflow-providers-google google-cloud-bigquery pandas

      - name: Lint Python files
        run: |
          flake8 dags/ --max-line-length=120 --ignore=E501,W503

      - name: Validate DAGs
        run: |
          python -c "
          import sys
          from airflow.models import DagBag
          dag_bag = DagBag(dag_folder='dags/', include_examples=False)
          if dag_bag.import_errors:
              print('DAG import errors:')
              for dag, error in dag_bag.import_errors.items():
                  print(f'{dag}: {error}')
              sys.exit(1)
          print(f'Found {len(dag_bag.dags)} valid DAGs')
          "

      - name: Run tests
        run: |
          pytest tests/ -v

  # Job 2: Terraform validation
  terraform:
    name: Terraform Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

  # Job 3: Deploy (only on main branch)
  deploy:
    name: Deploy to GCP
    needs: [lint, terraform]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy info
        run: |
          echo "Deployment would happen here:"
          echo "1. Copy DAGs to Cloud Composer bucket"
          echo "2. Apply Terraform changes"
          echo ""
          echo "Commands that would run:"
          echo "  gsutil -m cp -r dags/* gs://COMPOSER_BUCKET/dags/"
          echo "  cd terraform && terraform apply -auto-approve"
